function loadImage(a){if(!a.type.match(/image.*/))return void console.log("The dropped file is not an image: ",a.type);var b=new FileReader;b.onload=function(a){render(a.target.result)},b.readAsDataURL(a)}function handleFileSelect(a){a.stopPropagation(),a.preventDefault();var b=a.target.files[0];loadImage(b)}function render(a){var b=new Image;b.onload=function(){var a=document.getElementById("myCanvas");b.height>MAX_HEIGHT&&(b.width*=MAX_HEIGHT/b.height,b.height=MAX_HEIGHT);var c=a.getContext("2d");c.clearRect(0,0,a.width,a.height),a.width=b.width,a.height=b.height,c.drawImage(b,0,0,b.width,b.height)},b.src=a}function saveAsBlob(){var a=document.getElementById("myCanvas");a.toBlob(function(a){sendImage(a)},"image/jpeg",.9)}function sendImage(a){var b=1,c=b++;uploadTask=storageRef.child('images/testImage"'+c+'".jpeg').put(a),uploadTask.on("state_changed",null,function(a){console.error("Upload failed:",a)},function(){var a=uploadTask.snapshot.metadata.downloadURLs[0];$(".img-container").append('<img class="uploaded-img" src="'+a+'" >'),reportData.img=a,console.log("Uploaded",uploadTask.snapshot.totalBytes,"bytes."),console.log(uploadTask.snapshot.metadata),console.log("File available at",a)})}function init(){getCurrentPosition(),retrieveFromDB(),signIn(),signOut(),authStateChange(),submitReport()}function retrieveFromDB(){var a=firebase.database().ref("reports/").limitToLast(100);a.on("child_added",function(a){addReportElement(a.val().lng)})}function addReportElement(a){$(".recent-reports").append("<p>"+a+"</p>")}function getCurrentPosition(){var a={enableHighAccuracy:!0,timeout:5e3,maximumAge:0};navigator.geolocation?navigator.geolocation.getCurrentPosition(saveGeoData,error,a):alert("Sorry, you do not have geolocation enabled for your browser")}function saveGeoData(a){reportData.lat=a.coords.latitude,reportData.lng=a.coords.longitude}function error(a){console.warn("ERROR("+a.code+"): "+a.message)}function saveTextData(){reportData.msg=$("#new-report-message").val()}function saveDate(){var a=new Date;reportData.dateTime=a}function sendToDB(){var a=firebase.database().ref().child("reports").push().key,b={};return b["/reports/"+a]=reportData,b["/user-reports/"+reportData.user+"/"+a]=reportData,firebase.database().ref().update(b)}function submitReport(){$("#submit-report").click(function(a){a.preventDefault(),console.log("Submit Report clicked!"),console.log(reportData),saveTextData(),saveDate(),sendToDB()})}function signIn(){$("#sign-in").click(function(){console.log("sign in clicked"),firebase.auth().signInAnonymously()})}function signOut(){$("#sign-out").click(function(){console.log("sign out clicked"),alert("User signed out!"),firebase.auth().signOut()})}function authStateChange(){firebase.auth().onAuthStateChanged(function(a){a&&(alert("User signed-in!"),writeUserData(a.uid),reportData.user=a.uid)})}function writeUserData(a){firebase.database().ref("users/"+a).set({userId:a})}var storageRef=firebase.storage().ref();window.onload=function(){document.getElementById("imgFile").addEventListener("change",handleFileSelect,!1)};var MAX_HEIGHT=250;$("#upload-img").click(function(){saveAsBlob()});var reportData={};$(function(){init()});